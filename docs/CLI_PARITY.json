{
  "version": "0.2.0",
  "description": "CLI flag/config parity artifact. Machine-checkable source of truth for CLI flags.",
  "commands": {
    "run": {
      "description": "Execute a script run (the only execution entrypoint)",
      "flags": {
        "config": {
          "type": "string",
          "required": false,
          "description": "Path to YAML config file (project-level defaults for quarry run)"
        },
        "script": {
          "type": "string",
          "required": true,
          "description": "Path to script file"
        },
        "run-id": {
          "type": "string",
          "required": true,
          "description": "Run ID"
        },
        "attempt": {
          "type": "int",
          "required": false,
          "default": 1,
          "description": "Attempt number (starts at 1)"
        },
        "job-id": {
          "type": "string",
          "required": false,
          "description": "Job ID (optional)"
        },
        "parent-run-id": {
          "type": "string",
          "required": false,
          "description": "Parent run ID (required for retries)"
        },
        "job": {
          "type": "string",
          "required": false,
          "description": "Job payload as inline JSON object (mutually exclusive with --job-json)",
          "validation": "Must be a top-level JSON object. Arrays, primitives, and null are rejected.",
          "exclusiveWith": ["job-json"]
        },
        "job-json": {
          "type": "string",
          "required": false,
          "description": "Path to JSON file containing job payload object (mutually exclusive with --job)",
          "validation": "File must contain a top-level JSON object. Arrays, primitives, and null are rejected.",
          "exclusiveWith": ["job"]
        },
        "executor": {
          "type": "string",
          "required": false,
          "description": "Path to executor binary (advanced: auto-resolved by default)"
        },
        "browser-ws-endpoint": {
          "type": "string",
          "required": false,
          "description": "WebSocket URL of an externally managed browser (connect instead of launch)",
          "notes": "When set, executor connects via puppeteer.connect() instead of launching a new browser. Proxy launch args are ignored; page.authenticate() still applies."
        },
        "quiet": {
          "type": "bool",
          "required": false,
          "description": "Suppress result output"
        },
        "source": {
          "type": "string",
          "required": false,
          "description": "Source identifier for partitioning (required)",
          "notes": "Required at runtime; can be provided via --config file instead of CLI flag"
        },
        "category": {
          "type": "string",
          "required": false,
          "default": "default",
          "description": "Category identifier for partitioning"
        },
        "policy": {
          "type": "string",
          "required": false,
          "default": "strict",
          "description": "Ingestion policy: strict, buffered, or streaming",
          "validation": "Must be one of: strict, buffered, streaming"
        },
        "flush-mode": {
          "type": "string",
          "required": false,
          "default": "at_least_once",
          "description": "Flush mode for buffered policy: at_least_once, chunks_first, two_phase",
          "validation": "Must be one of: at_least_once, chunks_first, two_phase",
          "dependsOn": ["policy=buffered"]
        },
        "buffer-events": {
          "type": "int",
          "required": false,
          "description": "Max buffered events (buffered policy)",
          "dependsOn": ["policy=buffered"]
        },
        "buffer-bytes": {
          "type": "int64",
          "required": false,
          "description": "Max buffer size in bytes (buffered policy)",
          "dependsOn": ["policy=buffered"]
        },
        "flush-count": {
          "type": "int",
          "required": false,
          "description": "Flush after N events accumulate (streaming policy)",
          "dependsOn": ["policy=streaming"]
        },
        "flush-interval": {
          "type": "duration",
          "required": false,
          "description": "Flush every duration, e.g. 5s, 30s (streaming policy)",
          "dependsOn": ["policy=streaming"]
        },
        "proxy-config": {
          "type": "string",
          "required": false,
          "description": "Path to proxy pools config file (JSON)",
          "dependsOn": ["proxy-pool"],
          "notes": "Deprecated: define proxy pools in quarry.yaml under the proxies: key instead"
        },
        "proxy-pool": {
          "type": "string",
          "required": false,
          "description": "Pool name to select proxy from"
        },
        "proxy-strategy": {
          "type": "string",
          "required": false,
          "description": "Strategy override: round_robin, random, or sticky",
          "validation": "Must be one of: round_robin, random, sticky"
        },
        "proxy-sticky-key": {
          "type": "string",
          "required": false,
          "description": "Sticky key override for proxy selection"
        },
        "proxy-domain": {
          "type": "string",
          "required": false,
          "description": "Domain for sticky scope derivation (when scope=domain)"
        },
        "proxy-origin": {
          "type": "string",
          "required": false,
          "description": "Origin for sticky scope derivation (when scope=origin, format: scheme://host:port)"
        },
        "storage-dataset": {
          "type": "string",
          "required": false,
          "default": "quarry",
          "description": "Lode dataset ID (overrides default \"quarry\")"
        },
        "storage-backend": {
          "type": "string",
          "required": false,
          "description": "Storage backend: fs (filesystem) or s3 (Amazon S3)",
          "validation": "Must be one of: fs, s3",
          "notes": "Required at runtime; can be provided via --config file instead of CLI flag"
        },
        "storage-path": {
          "type": "string",
          "required": false,
          "description": "Storage path (fs: writable directory, s3: bucket/prefix)",
          "notes": "Required at runtime; can be provided via --config file instead of CLI flag"
        },
        "storage-region": {
          "type": "string",
          "required": false,
          "description": "AWS region for S3 backend (uses default credential chain if omitted)"
        },
        "storage-endpoint": {
          "type": "string",
          "required": false,
          "description": "Custom S3 endpoint URL for S3-compatible providers (e.g. Cloudflare R2, MinIO)",
          "dependsOn": ["storage-backend=s3"]
        },
        "storage-s3-path-style": {
          "type": "bool",
          "required": false,
          "description": "Force path-style addressing for S3 (required by R2, MinIO)",
          "dependsOn": ["storage-backend=s3"]
        },
        "adapter": {
          "type": "string",
          "required": false,
          "description": "Event-bus adapter type (webhook, redis)",
          "validation": "Must be one of: webhook, redis"
        },
        "adapter-url": {
          "type": "string",
          "required": false,
          "description": "Adapter endpoint URL (required when --adapter is set)",
          "dependsOn": ["adapter"]
        },
        "adapter-header": {
          "type": "string_slice",
          "required": false,
          "description": "Custom HTTP header as key=value (repeatable)",
          "dependsOn": ["adapter"]
        },
        "adapter-timeout": {
          "type": "duration",
          "required": false,
          "default": "10s",
          "description": "Adapter notification timeout",
          "dependsOn": ["adapter"]
        },
        "adapter-retries": {
          "type": "int",
          "required": false,
          "default": 3,
          "description": "Adapter retry attempts",
          "dependsOn": ["adapter"]
        },
        "adapter-channel": {
          "type": "string",
          "required": false,
          "description": "Pub/sub channel name for Redis adapter (default: quarry:run_completed)",
          "dependsOn": ["adapter=redis"]
        },
        "depth": {
          "type": "int",
          "required": false,
          "description": "Maximum fan-out recursion depth (0 = disabled)",
          "notes": "When > 0, --max-runs is required as a safety rail"
        },
        "max-runs": {
          "type": "int",
          "required": false,
          "description": "Maximum total child runs (required when --depth > 0)",
          "dependsOn": ["depth>0"],
          "notes": "Safety rail to prevent unbounded fan-out"
        },
        "parallel": {
          "type": "int",
          "required": false,
          "default": 1,
          "description": "Maximum concurrent child runs",
          "dependsOn": ["depth>0"]
        },
        "no-browser-reuse": {
          "type": "bool",
          "required": false,
          "description": "Disable transparent browser reuse across runs",
          "notes": "When set, each run launches and closes its own Chromium instance. By default, a reusable browser server is started and shared across sequential runs."
        }
      }
    },
    "inspect": {
      "description": "Deep view of a single entity",
      "subcommands": {
        "run": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "job": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "task": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "proxy": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "executor": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        }
      }
    },
    "stats": {
      "description": "Aggregated facts derived from the read path",
      "subcommands": {
        "runs": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "jobs": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "tasks": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "proxies": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "executors": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            }
          }
        },
        "metrics": {
          "flags": {
            "storage-dataset": {
              "type": "string",
              "required": false,
              "default": "quarry",
              "description": "Lode dataset ID (default: \"quarry\")"
            },
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "description": "Enable interactive TUI mode"
            },
            "storage-backend": {
              "type": "string",
              "required": false,
              "description": "Storage backend: fs or s3",
              "validation": "Must be one of: fs, s3"
            },
            "storage-path": {
              "type": "string",
              "required": false,
              "description": "Storage path (fs: directory, s3: bucket/prefix)"
            },
            "storage-region": {
              "type": "string",
              "required": false,
              "description": "AWS region for S3 backend"
            },
            "run-id": {
              "type": "string",
              "required": false,
              "description": "Read metrics for specific run ID"
            },
            "source": {
              "type": "string",
              "required": false,
              "description": "Filter by source partition"
            }
          }
        }
      }
    },
    "list": {
      "description": "Thin enumerations (not inspect-level detail)",
      "subcommands": {
        "runs": {
          "flags": {
            "state": {
              "type": "string",
              "required": false,
              "description": "Filter by state: running, failed, succeeded",
              "validation": "Must be one of: running, failed, succeeded"
            },
            "limit": {
              "type": "int",
              "required": false,
              "default": 0,
              "description": "Maximum number of runs to return (0 = no limit)"
            },
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Enable interactive TUI mode",
              "notes": "Not supported for list commands - returns error"
            }
          }
        },
        "jobs": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Enable interactive TUI mode",
              "notes": "Not supported for list commands - returns error"
            }
          }
        },
        "pools": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Enable interactive TUI mode",
              "notes": "Not supported for list commands - returns error"
            }
          }
        },
        "executors": {
          "flags": {
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Enable interactive TUI mode",
              "notes": "Not supported for list commands - returns error"
            }
          }
        }
      }
    },
    "debug": {
      "description": "Diagnostic tools (resolve proxy, ipc)",
      "subcommands": {
        "resolve proxy": {
          "flags": {
            "commit": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Commit the resolution (advance rotation counters)"
            },
            "proxy-config": {
              "type": "string",
              "required": true,
              "description": "Path to proxy pools config file (JSON)"
            },
            "strategy": {
              "type": "string",
              "required": false,
              "description": "Strategy override: round_robin, random, or sticky",
              "validation": "Must be one of: round_robin, random, sticky"
            },
            "sticky-key": {
              "type": "string",
              "required": false,
              "description": "Sticky key for proxy selection"
            },
            "job-id": {
              "type": "string",
              "required": false,
              "description": "Job ID for sticky scope derivation"
            },
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Enable interactive TUI mode",
              "notes": "Not supported for debug commands - returns error"
            }
          }
        },
        "ipc": {
          "flags": {
            "verbose": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Include payload details"
            },
            "format": {
              "type": "string",
              "aliases": ["f"],
              "required": false,
              "description": "Output format: json, table, yaml"
            },
            "no-color": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Disable colored output (table format only)"
            },
            "tui": {
              "type": "bool",
              "required": false,
              "default": false,
              "description": "Enable interactive TUI mode",
              "notes": "Not supported for debug commands - returns error"
            }
          }
        }
      }
    },
    "version": {
      "description": "Reports the canonical project version (lockstep across all components)",
      "flags": {
        "format": {
          "type": "string",
          "aliases": ["f"],
          "required": false,
          "description": "Output format: json, table, yaml"
        },
        "no-color": {
          "type": "bool",
          "required": false,
          "description": "Disable colored output (table format only)"
        },
        "tui": {
          "type": "bool",
          "required": false,
          "description": "Enable interactive TUI mode",
          "notes": "Not supported for version command - returns error"
        }
      }
    }
  }
}
