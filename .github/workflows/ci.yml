name: "ğŸ¤– CI"

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  version-lockstep:
    name: "ğŸ”’ Version Lockstep"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ”’ Check Version Lockstep"
        run: |
          GO_VERSION=$(grep -oP 'const Version = "\K[^"]+' quarry/types/version.go)
          SDK_VERSION=$(jq -r '.version' sdk/package.json)
          echo "Go version: $GO_VERSION"
          echo "SDK version: $SDK_VERSION"
          if [ "$GO_VERSION" != "$SDK_VERSION" ]; then
            echo "::error::Version mismatch! quarry/types/version.go ($GO_VERSION) != sdk/package.json ($SDK_VERSION)"
            exit 1
          fi
          echo "âœ… Versions match: $GO_VERSION"

  cli-parity:
    name: "ğŸ“‹ CLI Parity"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“‹ Check CLI Parity"
        run: |
          cd quarry
          # Guard: ensure at least one parity test exists (prevents false-pass)
          PARITY_TESTS=$(go test ./cli/cmd -list 'TestCLIParity' 2>/dev/null | grep -c 'TestCLIParity' || true)
          if [ "$PARITY_TESTS" -eq 0 ]; then
            echo "::error::No TestCLIParity* tests found - strict parity gate requires at least one"
            exit 1
          fi
          echo "Found $PARITY_TESTS parity tests"
          go test ./cli/cmd -run Parity -v
          echo "âœ… CLI parity artifact is in sync"

  lint:
    name: "ğŸ§¹ Lint"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Install dependencies"
        run: pnpm install
      - name: "ğŸ§¹ Lint"
        run: task lint

  test:
    name: "ğŸ§ª Test"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Install dependencies"
        run: pnpm install
      - name: "ğŸ§ª Test"
        run: task test

  bundle-freshness:
    name: "ğŸ“¦ Bundle Freshness"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Install dependencies"
        run: pnpm install
      - name: "ğŸ“¦ Regenerate bundle"
        run: task executor:bundle
      - name: "ğŸ” Check for drift"
        run: |
          if ! git diff --exit-code quarry/executor/bundle/executor.mjs; then
            echo "::error::Embedded executor bundle is stale. Run 'task executor:bundle' and commit the result."
            exit 1
          fi
          echo "âœ… Bundle is fresh"

  build:
    name: "ğŸ—ï¸ Build"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Install dependencies"
        run: pnpm install
      - name: "ğŸ—ï¸ Build"
        run: task build

  examples:
    name: "ğŸ“¦ Examples"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Install dependencies"
        run: pnpm install
      - name: "ğŸ“¦ Run Examples"
        run: task examples
        env:
          QUARRY_NO_SANDBOX: "1"
      - name: "â¬†ï¸ Upload Example Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: example-run-logs
          path: .example-runs/
          retention-days: 14
