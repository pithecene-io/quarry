name: üì¶ Release

on:
  push:
    tags: [v*]

permissions:
  contents: write
  packages: write

jobs:
  tag_check:
    name: üîé Tag Check
    runs-on: ubuntu-latest
    outputs:
      semver_match: ${{ steps.regex-match.outputs.match }}
    steps:
      - name: üîé Match SemVer Tag
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.ref_name }}
          regex: ^v[0-9]+\.[0-9]+\.[0-9]+$

  version_lockstep:
    name: üîí Version Lockstep
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîí Check Version Matches Tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          GO_VERSION=$(grep -oP 'const Version = "\K[^"]+' quarry/types/version.go)
          SDK_VERSION=$(jq -r '.version' sdk/package.json)
          echo "Tag version: $TAG_VERSION"
          echo "Go version: $GO_VERSION"
          echo "SDK version: $SDK_VERSION"
          if [ "$GO_VERSION" != "$SDK_VERSION" ]; then
            echo "::error::Version mismatch! quarry/types/version.go ($GO_VERSION) != sdk/package.json ($SDK_VERSION)"
            exit 1
          fi
          if [ "$GO_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Tag mismatch! Tag ($TAG_VERSION) != code version ($GO_VERSION)"
            exit 1
          fi
          echo "‚úÖ All versions match: $TAG_VERSION"

  lint:
    name: üßπ Lint
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üßπ Lint
        run: task lint

  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üß™ Test
        run: task test

  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üèóÔ∏è Build
        run: task build

  examples:
    name: üì¶ Examples
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üì¶ Run Examples
        run: task examples
        env:
          QUARRY_NO_SANDBOX: "1"

  cross-compile:
    name: üî® Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [version_lockstep, lint, test, build, examples]
    if: ${{ needs.version_lockstep.result == 'success' }}
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üì¶ Bundle executor
        run: task executor:bundle

      - name: üî® Build
        working-directory: quarry
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: go build -o quarry ./cmd/quarry

      - name: üì¶ Archive
        run: |
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME}"
          ARCHIVE="quarry_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz"
          tar -czf "dist/${ARCHIVE}" -C quarry quarry
          sha256sum "dist/${ARCHIVE}" > "dist/${ARCHIVE}.sha256"

      - name: ‚¨ÜÔ∏è Upload
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

  package:
    name: üì¶ Package
    runs-on: ubuntu-latest
    needs: [cross-compile]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üì¶ Package source & SDK
        run: |
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME}"
          git archive --format=tar.gz --output="dist/quarry-${VERSION}.tar.gz" HEAD
          sha256sum "dist/quarry-${VERSION}.tar.gz" > "dist/quarry-${VERSION}.tar.gz.sha256"
          cd sdk
          pnpm pack
          SDK_TARBALL="$(ls -t *.tgz | head -n 1)"
          cd ..
          mv "sdk/${SDK_TARBALL}" "dist/quarry-sdk-${VERSION}.tgz"
          sha256sum "dist/quarry-sdk-${VERSION}.tgz" > "dist/quarry-sdk-${VERSION}.tgz.sha256"

      - name: ‚¨áÔ∏è Download platform binaries
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          path: dist/
          merge-multiple: true

      - name: üìã Generate checksums manifest
        run: |
          cd dist
          sha256sum quarry_*.tar.gz > checksums.txt
          cat checksums.txt

      - name: ‚¨ÜÔ∏è Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/

  hold:
    name: ‚è∏Ô∏è Release Approval
    runs-on: ubuntu-latest
    needs: [package]
    environment:
      name: release
    steps:
      - name: ‚úÖ Await Approval
        run: echo "Release approved; continuing."

  release:
    name: üöÄ GitHub Release
    runs-on: ubuntu-latest
    needs: [hold]
    steps:
      - name: ‚¨áÔ∏è Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist

      - name: üöÄ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: dist/*

  publish_ghpr:
    name: üì¶ Publish SDK (GitHub Packages)
    runs-on: ubuntu-latest
    needs: [hold]
    permissions:
      contents: read
      packages: write
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup Node for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: 24.13.0
          registry-url: https://npm.pkg.github.com
          scope: "@pithecene-io"

      - name: üì¶ Setup pnpm via Corepack
        run: |
          EXPECTED_PNPM=$(jq -r '.packageManager' package.json | sed 's/pnpm@\([^+]*\).*/\1/')
          echo "üîß Preparing pnpm@${EXPECTED_PNPM} via Corepack"
          corepack enable
          corepack prepare "pnpm@${EXPECTED_PNPM}" --activate

      - name: üîç Verify Toolchain Pinning
        run: |
          echo "üîß Node version: $(node --version)"
          ACTUAL_PNPM=$(pnpm --version)
          EXPECTED_PNPM=$(jq -r '.packageManager' package.json | sed 's/pnpm@\([^+]*\).*/\1/')
          echo "üîß pnpm version (actual): $ACTUAL_PNPM"
          echo "üîß pnpm version (pinned): $EXPECTED_PNPM"
          if [ "$ACTUAL_PNPM" != "$EXPECTED_PNPM" ]; then
            echo "::error::pnpm version mismatch! Actual ($ACTUAL_PNPM) != Pinned ($EXPECTED_PNPM)"
            exit 1
          fi
          echo "‚úÖ pnpm version matches pin"

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üèóÔ∏è Build SDK
        working-directory: sdk
        run: pnpm run build

      - name: üîç Publish Diagnostics
        working-directory: sdk
        run: |
          echo "üì¶ Package: $(jq -r '.name' package.json)"
          echo "üì¶ Version: $(jq -r '.version' package.json)"
          echo "üì¶ Registry: $(npm config get registry)"
          echo "üì¶ Scope registry: $(npm config get @pithecene-io:registry || echo 'not set')"

      - name: üì¶ Publish
        working-directory: sdk
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm publish --access restricted --no-git-checks

  publish_jsr:
    name: üì¶ Publish SDK (JSR)
    runs-on: ubuntu-latest
    needs: [hold]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Setup
        uses: jdx/mise-action@v2

      - name: üì¶ Install dependencies
        run: pnpm install

      - name: üì¶ Publish
        working-directory: sdk
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          npx jsr publish --set-version "$VERSION"

  container:
    name: üê≥ Container Images
    runs-on: ubuntu-latest
    needs: [hold]
    permissions:
      contents: read
      packages: write
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: üê≥ Build & push (slim)
        uses: docker/build-push-action@v6
        with:
          context: .
          target: slim
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/pithecene-io/quarry:${{ steps.version.outputs.version }}-slim
            ghcr.io/pithecene-io/quarry:slim
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üê≥ Build & push (full)
        uses: docker/build-push-action@v6
        with:
          context: .
          target: full
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/pithecene-io/quarry:${{ steps.version.outputs.version }}
            ghcr.io/pithecene-io/quarry:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
