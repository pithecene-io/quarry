name: ğŸ“¦ Release

on:
  push:
    tags: [v*]

permissions:
  contents: write
  packages: write

jobs:
  tag_check:
    name: ğŸ” Tag Check
    runs-on: ubuntu-latest
    outputs:
      semver_match: ${{ steps.regex-match.outputs.match }}
    steps:
      - name: ğŸ” Match SemVer Tag
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.ref_name }}
          regex: ^v[0-9]+\.[0-9]+\.[0-9]+$

  version_lockstep:
    name: ğŸ”’ Version Lockstep
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”’ Check Version Matches Tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          GO_VERSION=$(grep -oP 'const Version = "\K[^"]+' quarry/types/version.go)
          SDK_VERSION=$(jq -r '.version' sdk/package.json)
          echo "Tag version: $TAG_VERSION"
          echo "Go version: $GO_VERSION"
          echo "SDK version: $SDK_VERSION"
          if [ "$GO_VERSION" != "$SDK_VERSION" ]; then
            echo "::error::Version mismatch! quarry/types/version.go ($GO_VERSION) != sdk/package.json ($SDK_VERSION)"
            exit 1
          fi
          if [ "$GO_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Tag mismatch! Tag ($TAG_VERSION) != code version ($GO_VERSION)"
            exit 1
          fi
          echo "âœ… All versions match: $TAG_VERSION"

  lint:
    name: ğŸ§¹ Lint
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§¹ Lint
        run: task lint

  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ§ª Test
        run: task test

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build
        run: task build

  examples:
    name: ğŸ“¦ Examples
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Run Examples
        run: task examples
        env:
          QUARRY_NO_SANDBOX: "1"

  cross-compile:
    name: ğŸ”¨ Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [version_lockstep, lint, test, build, examples]
    if: ${{ needs.version_lockstep.result == 'success' }}
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Bundle executor
        run: task executor:bundle

      - name: ğŸ”¨ Build
        working-directory: quarry
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: go build -o quarry ./cmd/quarry

      - name: ğŸ“¦ Archive
        run: |
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME}"
          ARCHIVE="quarry_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz"
          tar -czf "dist/${ARCHIVE}" -C quarry quarry
          sha256sum "dist/${ARCHIVE}" > "dist/${ARCHIVE}.sha256"

      - name: â¬†ï¸ Upload
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

  package:
    name: ğŸ“¦ Package
    runs-on: ubuntu-latest
    needs: [cross-compile]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Package source & SDK
        run: |
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME}"
          git archive --format=tar.gz --output="dist/quarry-${VERSION}.tar.gz" HEAD
          sha256sum "dist/quarry-${VERSION}.tar.gz" > "dist/quarry-${VERSION}.tar.gz.sha256"
          cd sdk
          pnpm pack
          SDK_TARBALL="$(ls -t *.tgz | head -n 1)"
          cd ..
          mv "sdk/${SDK_TARBALL}" "dist/quarry-sdk-${VERSION}.tgz"
          sha256sum "dist/quarry-sdk-${VERSION}.tgz" > "dist/quarry-sdk-${VERSION}.tgz.sha256"

      - name: â¬‡ï¸ Download platform binaries
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          path: dist/
          merge-multiple: true

      - name: ğŸ“‹ Generate checksums manifest
        run: |
          cd dist
          sha256sum quarry_*.tar.gz > checksums.txt
          cat checksums.txt

      - name: â¬†ï¸ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/

  hold:
    name: â¸ï¸ Release Approval
    runs-on: ubuntu-latest
    needs: [package]
    environment:
      name: release
    steps:
      - name: âœ… Await Approval
        run: echo "Release approved; continuing."

  release:
    name: ğŸš€ GitHub Release
    runs-on: ubuntu-latest
    needs: [hold]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist

      - name: ğŸ” Check for existing release
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          BODY=$(gh release view "$TAG" \
            --json body -q '.body' 2>/dev/null || echo "")
          if echo "$BODY" | grep -qv "TODO: Add release notes"; then
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ“ Upload assets to existing release
        if: steps.existing.outputs.has_notes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ github.ref_name }}" dist/* --clobber

      - name: ğŸš€ Create draft release
        if: steps.existing.outputs.has_notes != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: false
          draft: true
          body: |
            <!-- Replace this with the release body per the GitHub release format standard in CLAUDE.md -->
            **TODO: Add release notes before publishing**
          files: dist/*

  publish_ghpr:
    name: ğŸ“¦ Publish SDK (GitHub Packages)
    runs-on: ubuntu-latest
    needs: [hold]
    permissions:
      contents: read
      packages: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: 24.13.0
          registry-url: https://npm.pkg.github.com
          scope: "@pithecene-io"

      - name: ğŸ“¦ Setup pnpm via Corepack
        run: |
          EXPECTED_PNPM=$(jq -r '.packageManager' package.json | sed 's/pnpm@\([^+]*\).*/\1/')
          echo "ğŸ”§ Preparing pnpm@${EXPECTED_PNPM} via Corepack"
          corepack enable
          corepack prepare "pnpm@${EXPECTED_PNPM}" --activate

      - name: ğŸ” Verify Toolchain Pinning
        run: |
          echo "ğŸ”§ Node version: $(node --version)"
          ACTUAL_PNPM=$(pnpm --version)
          EXPECTED_PNPM=$(jq -r '.packageManager' package.json | sed 's/pnpm@\([^+]*\).*/\1/')
          echo "ğŸ”§ pnpm version (actual): $ACTUAL_PNPM"
          echo "ğŸ”§ pnpm version (pinned): $EXPECTED_PNPM"
          if [ "$ACTUAL_PNPM" != "$EXPECTED_PNPM" ]; then
            echo "::error::pnpm version mismatch! Actual ($ACTUAL_PNPM) != Pinned ($EXPECTED_PNPM)"
            exit 1
          fi
          echo "âœ… pnpm version matches pin"

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build SDK
        working-directory: sdk
        run: pnpm run build

      - name: ğŸ” Publish Diagnostics
        working-directory: sdk
        run: |
          echo "ğŸ“¦ Package: $(jq -r '.name' package.json)"
          echo "ğŸ“¦ Version: $(jq -r '.version' package.json)"
          echo "ğŸ“¦ Registry: $(npm config get registry)"
          echo "ğŸ“¦ Scope registry: $(npm config get @pithecene-io:registry || echo 'not set')"

      - name: ğŸ“¦ Publish
        working-directory: sdk
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm publish --access restricted --no-git-checks

  publish_jsr:
    name: ğŸ“¦ Publish SDK (JSR)
    runs-on: ubuntu-latest
    needs: [hold]
    permissions:
      contents: read
      id-token: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup
        uses: jdx/mise-action@v2

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ“¦ Publish
        working-directory: sdk
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          npx jsr publish --set-version "$VERSION"

  container:
    name: ğŸ³ Container Images
    runs-on: ubuntu-latest
    needs: [hold]
    permissions:
      contents: read
      packages: write
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: ğŸ³ Build & push (slim)
        uses: docker/build-push-action@v6
        with:
          context: .
          target: slim
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/pithecene-io/quarry:${{ steps.version.outputs.version }}-slim
            ghcr.io/pithecene-io/quarry:slim
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ³ Build & push (full, amd64 only)
        uses: docker/build-push-action@v6
        with:
          context: .
          target: full
          push: true
          platforms: linux/amd64
          tags: |
            ghcr.io/pithecene-io/quarry:${{ steps.version.outputs.version }}
            ghcr.io/pithecene-io/quarry:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
