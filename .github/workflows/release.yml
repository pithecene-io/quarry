name: "ğŸ“¦ Release"

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  packages: write

jobs:
  tag_check:
    name: "ğŸ” Tag Check"
    runs-on: ubuntu-latest
    outputs:
      semver_match: ${{ steps.regex-match.outputs.match }}
    steps:
      - name: "ğŸ” Match SemVer Tag"
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.ref_name }}
          regex: '^v[0-9]+\.[0-9]+\.[0-9]+$'

  version_lockstep:
    name: "ğŸ”’ Version Lockstep"
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ”’ Check Version Matches Tag"
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          GO_VERSION=$(grep -oP 'const Version = "\K[^"]+' quarry/types/version.go)
          SDK_VERSION=$(jq -r '.version' sdk/package.json)
          echo "Tag version: $TAG_VERSION"
          echo "Go version: $GO_VERSION"
          echo "SDK version: $SDK_VERSION"
          if [ "$GO_VERSION" != "$SDK_VERSION" ]; then
            echo "::error::Version mismatch! quarry/types/version.go ($GO_VERSION) != sdk/package.json ($SDK_VERSION)"
            exit 1
          fi
          if [ "$GO_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Tag mismatch! Tag ($TAG_VERSION) != code version ($GO_VERSION)"
            exit 1
          fi
          echo "âœ… All versions match: $TAG_VERSION"

  package:
    name: "ğŸ“¦ Package"
    runs-on: ubuntu-latest
    needs: [tag_check, version_lockstep]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Package"
        run: |
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME}"
          git archive --format=tar.gz --output="dist/quarry-${VERSION}.tar.gz" HEAD
          sha256sum "dist/quarry-${VERSION}.tar.gz" > "dist/quarry-${VERSION}.tar.gz.sha256"
          cd sdk
          pnpm pack
          SDK_TARBALL="$(ls -t *.tgz | head -n 1)"
          cd ..
          mv "sdk/${SDK_TARBALL}" "dist/quarry-sdk-${VERSION}.tgz"
          sha256sum "dist/quarry-sdk-${VERSION}.tgz" > "dist/quarry-sdk-${VERSION}.tgz.sha256"
      - name: "â¬†ï¸ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/

  hold:
    name: "â¸ï¸ Release Approval"
    runs-on: ubuntu-latest
    needs: [package]
    environment:
      name: release
    steps:
      - name: "âœ… Await Approval"
        run: echo "Release approved; continuing."

  release:
    name: "ğŸš€ GitHub Release"
    runs-on: ubuntu-latest
    needs: [hold]
    steps:
      - name: "â¬‡ï¸ Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist
      - name: "ğŸš€ Create Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: dist/*

  publish_npm:
    name: "ğŸ“¦ Publish SDK (GitHub Packages)"
    runs-on: ubuntu-latest
    needs: [hold]
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ§° Setup"
        uses: jdx/mise-action@v2
      - name: "ğŸ“¦ Publish"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm config set registry https://npm.pkg.github.com
          cd sdk
          pnpm publish --access restricted --no-git-checks
